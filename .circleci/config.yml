version: 2.1
orbs:
  win: circleci/windows@2.1.0
commands:
  setup-linux-builder:
    description: Setup Artichoke Linux builder image
    steps:
      - run:
          name: Installed Toolchain Versions
          command: |
            rustc --version --verbose
            cargo --version --verbose
  setup-linux-linter:
    description: Setup Artichoke Linux linter image
    steps:
      - setup-linux-builder
      - run:
          name: Install nightly Rust
          command: |
            rustup install nightly
      - run:
          name: Install Rust Toolchain
          command: |
            rustup component add rustfmt
            rustup component add clippy
      - run:
          name: Installed Toolchain Versions
          command: |
            rustc --version --verbose
            cargo --version --verbose
            rustfmt --version
            cargo clippy -- --version
jobs:
  x86_64-linux:
    docker:
      - image: circleci/rust:latest
    resource_class: large
    steps:
      - checkout
      - setup-linux-builder
      - run:
          name: Build Workspace
          command: |
            cargo build
          environment:
            RUST_BACKTRACE: 1
      - run:
          name: Test Workspace
          command: |
            cargo test --all-features
          environment:
            RUST_BACKTRACE: 1
  linter:
    docker:
      - image: circleci/rust:latest
    resource_class: large
    steps:
      - checkout
      - setup-linux-linter
      - run:
          name: rustfmt
          command: |
            cargo fmt -- --check --color=auto
      - run:
          name: clippy
          command: |
            cargo clippy -- -D warnings
      - run:
          name: doc
          command: |
            cargo +nightly doc
      - persist_to_workspace:
          root: target
          paths:
            - "doc"
  deploy:
    docker:
      - image: node:lts
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "42:fd:d3:6a:91:d4:0a:6f:b5:48:87:0e:2e:89:32:a3"
      - attach_workspace:
          at: target
      - run: npm install -g gh-pages@2.1.1
      - run:
          name: Deploy docs to gh-pages branch
          command: |
            gh-pages \
              --user "ci-build <ci-build@hyperbo.la>" \
              --message "[skip ci] build docs" \
              --dist target/doc
workflows:
  version: 2
  build:
    jobs:
      - x86_64-linux
      - linter
      - deploy:
          requires:
            - x86_64-linux
            - linter
          filters:
            branches:
              only: master
